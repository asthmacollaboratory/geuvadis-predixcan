#!/usr/bin/env Rscript --vanilla
#
# coded by Kevin L. Keys (2018)

# load libraries
suppressMessages(library(data.table))
suppressMessages(library(dplyr))
suppressMessages(library(dunn.test))
suppressMessages(library(methods))


# format Utahn data
ceu = fread("geuvadis.crosspop.results.ceu.predictinto.allpop.results.txt")
colnames(ceu)[c(2,3,5)] = c("Test_Pop", "R2", "Correlation")
ceu$Train_Pop = "CEU"
ceu.sub = ceu %>% na.omit %>% select(Train_Pop, Test_Pop, Gene, R2, Correlation) %>% as.data.table

# format British data
gbr = fread("geuvadis.crosspop.results.gbr.predictinto.allpop.results.txt")
colnames(gbr)[c(2,3,5)] = c("Test_Pop", "R2", "Correlation")
gbr$Train_Pop = "GBR"
gbr.sub = gbr %>% na.omit %>% select(Train_Pop, Test_Pop, Gene, R2, Correlation) %>% as.data.table

# format Tuscan data
tsi = fread("geuvadis.crosspop.results.tsi.predictinto.allpop.results.txt")
tsi$Train_Pop = "TSI"
colnames(tsi)[c(2,3,5)] = c("Test_Pop", "R2", "Correlation")
tsi.sub = tsi %>% na.omit %>% select(Train_Pop, Test_Pop, Gene, R2, Correlation) %>% as.data.table

# format Finnish data
fin = fread("geuvadis.crosspop.results.fin.predictinto.allpop.results.txt")
fin$Train_Pop = "FIN"
colnames(fin)[c(2,3,5)] = c("Test_Pop", "R2", "Correlation")
fin.sub = fin %>% na.omit %>% select(Train_Pop, Test_Pop, Gene, R2, Correlation) %>% as.data.table

# format Yoruba data
yri = fread("geuvadis.crosspop.results.yri.predictinto.allpop.results.txt")
yri$Train_Pop = "YRI"
colnames(yri)[c(2,3,5)] = c("Test_Pop", "R2", "Correlation")
yri.sub = yri %>% na.omit %>% select(Train_Pop, Test_Pop, Gene, R2, Correlation) %>% as.data.table


# combine data into single data table
allpop = rbindlist(list(ceu.sub, gbr.sub, tsi.sub, fin.sub, yri.sub))

# add labels to distinguish various crosspop scenarios:
# EUR_AFR = EUR if train-test pops are both EUR, AFR otherwise
# Train_Test includes the *training* population, followed by the *testing* population
allpop.sub = allpop %>%
    dplyr::filter(Train_Pop != Test_Pop) %>%
    mutate(
        Train_Test = paste(Train_Pop, Test_Pop, sep = "_"),
        EUR_AFR = paste(
            ifelse(Train_Pop == "YRI" , "AFR", "EUR"),
            ifelse(Test_Pop == "YRI", "AFR", "EUR"),
            sep = "_"
        )
    ) %>%
    as.data.table


# Kruskal-Wallis tests determine significant differences in means 
kruskal.test(R2 ~ as.factor(EUR_AFR),    data = allpop.sub)
#kruskal.test(R2 ~ as.factor(Train_Test), data = allpop.sub)
#kruskal.test(R2 ~ as.factor(Train_Pop),  data = allpop.sub)
#kruskal.test(R2 ~ as.factor(Test_Pop),   data = allpop.sub)

# Dunn tests tease apart which groups are sig. diff. by KW test
# output list contains $P.adjusted, $Z, and $comparisons fields to describe p-values and KW statistics
r2.by.eurafr = dunn.test(x = allpop.sub$R2, g = allpop.sub$EUR_AFR, method = "bonferroni")
#dunn.test(x = allpop.sub$R2, g = allpop.sub$Train_Pop,  method = "bonferroni")
#dunn.test(x = allpop.sub$R2, g = allpop.sub$Test_Pop,   method = "bonferroni")
#dunn.test(x = allpop.sub$R2, g = allpop.sub$Train_Test, method = "bonferroni")  ## this takes awhile to compute
